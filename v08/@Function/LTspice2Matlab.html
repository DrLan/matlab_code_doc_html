<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of LTspice2Matlab</title>
  <meta name="keywords" content="LTspice2Matlab">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">v08</a> &gt; <a href="index.html">@Function</a> &gt; LTspice2Matlab.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for v08\@Function&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>LTspice2Matlab
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function raw_data = LTspice2Matlab( filename, varargin ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">

 LTSPICE2MATLAB -- Reads an LTspice IV .RAW waveform file containing data from a Transient Analysis (.tran) or
           AC Analysis (.ac) simulation, and converts voltages and currents vs. time into Matlab variables.  
           This function can read compressed binary, uncompressed binary, and ASCII file formats.  It does not 
           currently support files saved in the Fast Access Format.  In the case of compressed binary, 
           the data is automatically uncompressed using fast quadratic point insertion.

           LTspice IV is an excellent Spice III simulator &amp; schematic capture tool freely avaliable for
           download at www.linear.com/designtools/software.  It is optimized for simulation of switching regulators, but
           can simulate many other types of circuits as well and comes with a wide variety of component models.  Note
           that the LTspice uses a lossy compression format (enabled by default) with user adjustable error bounds.

           Use LTSPICE2MATLAB to import LTspice waveforms into Matlab for additional analysis or to 
           compare with measured data.
 
           This function has been tested with LTspice IV version 4.01p, and Matlab versions 6.1 and 7.5.  Regression
           testing has been used to expose the function to a wide range of LTspice settings.
           Author:  Paul Wagner  4/25/2009

 
    Calling Convention:
        RAW_DATA = LTSPICE2MATLAB( FILENAME );                  %Returns all variables found in FILENAME
                             (or)
        RAW_DATA = LTSPICE2MATLAB( FILENAME, SELECTED_VARS );   %Returns only those variables covered by SELECTED_VARS
               Set SELECTED_VARS to [] to quickly determine the number and names of variables present in FILENAME without
               actually loading the variables.
                             (or)
        RAW_DATA = LTSPICE2MATLAB( FILENAME, SELECTED_VARS, N );   
               Returns variables listed in SELECTED_VARS, with all waveforms downsampled by N.  Set N &gt; 1 to load 
               very large data files using less memory, at the price of degraded waveform accuracy and possible aliasing.

    Inputs:  FILENAME is a string containing the name and path of the LTspiceIV .raw file to be converted.

             SELECTED_VARS (optional) is a vector of indexes indicating which variables to extract from the .raw file.  
                  For example, if a .raw file has 14 variables and SELECTED_VARS is [1 8 9], then the output 
                  RAW_DATA.VARIABLE_MAT will be a 3 x NUM_DATA_PNTS matrix containing waveforms for
                  variables 1, 8, and 9 only.  Note that SELECTED_VARS does not cover the time (or frequency) variable 
                  (index 0), which is returned separately in RAW_DATA.TIME_VECT (or RAW_DATA.FREQ_VECT).  Extracting only 
                  of subset of variables is a way to use less memory when loading very large simulation files.

                  If this parameter is not specified, then all variables are returned by default.  Setting  
                  SELECTED_VARS to 'all' will also cause all variables to be returned.

             *  To quickly determine the number and names of variables present in a .raw file, call LTspice2Matlab with 
                  SELECTED_VARS set to [].  In this case, all fields in RAW_DATA will be populated, except 
                  .TIME_VECT (or .FREQ_VECT) and .VARIABLE_MAT, which will both be empty ([]).  Since only the header 
                  is read, the function call should execute very quickly, even for large files.

             N (optional) must be a positive integer &gt;= 1.  If N is specified, then SELECTED_VARS must also be specified.  
                  If N is unspecified, it defaults to 1, which does not change the sampling rate.  If this value is 2 
                  or larger, the returned voltage, current, and time data will be downsampled by keeping every N-th sample 
                  in the original data, starting with the first.  
                  Caution:  No lowpass filtering is applied prior to downsampling, so aliasing may occur.  Also, 
                  in many cases LTspice saves data with a non-constant sampling rate, in which case downsampling can
                  result in substantial waveform distortion.  This option should only be used if the waveform of 
                  interest is initially oversampled.

    Outputs:  RAW_DATA is a Matlab structure containing the following fields ...
                  title:                String containing the title appearing in the .RAW file header.
                  date:                 String containing the date appearing in the .RAW file header.
                  plotname:             String indicating simulation type ('Transient Analysis', 'AC Analysis')
                  conversion_notes:     Description of modifications (if any) done to the data during conversion.  
                  num_variables:        Number of variables (does not include the &quot;time&quot; or &quot;frequency&quot; variable)
                  variable_type_list:   A cell of strings indicating the variable type (i.e. voltage, current etc.)
                  variable_name_list:   A cell of strings indicating the name of each variable.
                  selected_vars:        A vector of indicies referencing VARIABLE_TYPE_LIST cells, corresponding 
                                        to each row in VARIABLE_MAT.
                  num_data_pnts:        Number of data points for each variable.
                  variable_mat:         Double precision matrix with NUM_VARIABLES rows and NUM_DATA_PNTS columns.
                                        This matrix contains node voltages (in Volts) and device currents (in Amps) 
                                        for each variable and each time point listed in TIME_VECT (or FREQ_VECT).
                                        For AC Analysis simulations, VARIABLE_MAT will have complex values showing
                                        the real and imaginary components of the voltage or current at the
                                        corresponding frequency.  To convert this to log magnitude and normalized
                                        phase representation used in LTspice plots, use the following formulas:
                                            Log_Magnitude_dB    =  20*log10(abs(variable_mat))
                                            Norm_Phase_degrees  =  angle(variable_mat)*180/pi
                  time_vect:            [Field returned for Transient Analysis only] Double precision row vector of 
                                        time values (in seconds) at each simulation point
                    (or)
                  freq_vect:            [Field returned for AC Analysis only] Double precision row vector of 
                                        frequency values (in Hz) at each simulation point

    ** Currently this function is able to import results from Transient Analysis (.tran) and AC Analysis (.ac)
       simulations only. 


    Examples
    --------
    These examples assume you've run a .TRAN simulation in LTspice for a hypothetical file called 
    BASIC_CIRCUIT.ASC, and that an output file called BASIC_CIRCUIT.RAW has been created.  It also assumes your   
    current Matlab directory is pointing to the directory where the .RAW file is located (or that you prepended
    the full path to the input parameter FILENAME).

    To import BASIC_CIRCUIT.RAW into Matlab and create a labeled plot of a single variable vs. time:

       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW');
       variable_to_plot = 1;   %This example plots the first variable in the data structure.
       plot(raw_data.time_vect, raw_data.variable_mat(variable_to_plot,:), 'k');
       title(sprintf('Waveform %s', raw_data.variable_name_list{variable_to_plot}));
       ylabel(raw_data.variable_type_list{variable_to_plot} );
       xlabel('Time (sec)' );
 
   To superimpose all variables in BASIC_CIRCUIT.RAW on a single graph with a legend:
 
       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW');
       plot(raw_data.time_vect, raw_data.variable_mat);
       title(sprintf( 'File:  %s', raw_data.title));
       legend(raw_data.variable_name_list);
       ylabel('Voltage (V) or Current (A)');
       xlabel('Time (sec)');
 
   To quickly determine the number and names of variables in BASIC_CIRCUIT.RAW without loading the entire file:
 
       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW', []);
       disp(sprintf( '\n\nThis file contains %.0f variables:\n', raw_data.num_variables));
       disp(sprintf('NAME         TYPE\n-------------------------'));
       disp([char(raw_data.variable_name_list), char(zeros(raw_data.num_variables,5)), char(raw_data.variable_type_list)]);</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>	TEMPLATE Convert a template object in a one line description string</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="Function.html" class="code" title="">Function</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function raw_data = LTspice2Matlab( filename, varargin )</a>
0002 <span class="comment">%</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% LTSPICE2MATLAB -- Reads an LTspice IV .RAW waveform file containing data from a Transient Analysis (.tran) or</span>
0005 <span class="comment">%           AC Analysis (.ac) simulation, and converts voltages and currents vs. time into Matlab variables.</span>
0006 <span class="comment">%           This function can read compressed binary, uncompressed binary, and ASCII file formats.  It does not</span>
0007 <span class="comment">%           currently support files saved in the Fast Access Format.  In the case of compressed binary,</span>
0008 <span class="comment">%           the data is automatically uncompressed using fast quadratic point insertion.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%           LTspice IV is an excellent Spice III simulator &amp; schematic capture tool freely avaliable for</span>
0011 <span class="comment">%           download at www.linear.com/designtools/software.  It is optimized for simulation of switching regulators, but</span>
0012 <span class="comment">%           can simulate many other types of circuits as well and comes with a wide variety of component models.  Note</span>
0013 <span class="comment">%           that the LTspice uses a lossy compression format (enabled by default) with user adjustable error bounds.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%           Use LTSPICE2MATLAB to import LTspice waveforms into Matlab for additional analysis or to</span>
0016 <span class="comment">%           compare with measured data.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%           This function has been tested with LTspice IV version 4.01p, and Matlab versions 6.1 and 7.5.  Regression</span>
0019 <span class="comment">%           testing has been used to expose the function to a wide range of LTspice settings.</span>
0020 <span class="comment">%           Author:  Paul Wagner  4/25/2009</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%    Calling Convention:</span>
0024 <span class="comment">%        RAW_DATA = LTSPICE2MATLAB( FILENAME );                  %Returns all variables found in FILENAME</span>
0025 <span class="comment">%                             (or)</span>
0026 <span class="comment">%        RAW_DATA = LTSPICE2MATLAB( FILENAME, SELECTED_VARS );   %Returns only those variables covered by SELECTED_VARS</span>
0027 <span class="comment">%               Set SELECTED_VARS to [] to quickly determine the number and names of variables present in FILENAME without</span>
0028 <span class="comment">%               actually loading the variables.</span>
0029 <span class="comment">%                             (or)</span>
0030 <span class="comment">%        RAW_DATA = LTSPICE2MATLAB( FILENAME, SELECTED_VARS, N );</span>
0031 <span class="comment">%               Returns variables listed in SELECTED_VARS, with all waveforms downsampled by N.  Set N &gt; 1 to load</span>
0032 <span class="comment">%               very large data files using less memory, at the price of degraded waveform accuracy and possible aliasing.</span>
0033 <span class="comment">%</span>
0034 <span class="comment">%    Inputs:  FILENAME is a string containing the name and path of the LTspiceIV .raw file to be converted.</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%             SELECTED_VARS (optional) is a vector of indexes indicating which variables to extract from the .raw file.</span>
0037 <span class="comment">%                  For example, if a .raw file has 14 variables and SELECTED_VARS is [1 8 9], then the output</span>
0038 <span class="comment">%                  RAW_DATA.VARIABLE_MAT will be a 3 x NUM_DATA_PNTS matrix containing waveforms for</span>
0039 <span class="comment">%                  variables 1, 8, and 9 only.  Note that SELECTED_VARS does not cover the time (or frequency) variable</span>
0040 <span class="comment">%                  (index 0), which is returned separately in RAW_DATA.TIME_VECT (or RAW_DATA.FREQ_VECT).  Extracting only</span>
0041 <span class="comment">%                  of subset of variables is a way to use less memory when loading very large simulation files.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%                  If this parameter is not specified, then all variables are returned by default.  Setting</span>
0044 <span class="comment">%                  SELECTED_VARS to 'all' will also cause all variables to be returned.</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%             *  To quickly determine the number and names of variables present in a .raw file, call LTspice2Matlab with</span>
0047 <span class="comment">%                  SELECTED_VARS set to [].  In this case, all fields in RAW_DATA will be populated, except</span>
0048 <span class="comment">%                  .TIME_VECT (or .FREQ_VECT) and .VARIABLE_MAT, which will both be empty ([]).  Since only the header</span>
0049 <span class="comment">%                  is read, the function call should execute very quickly, even for large files.</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%             N (optional) must be a positive integer &gt;= 1.  If N is specified, then SELECTED_VARS must also be specified.</span>
0052 <span class="comment">%                  If N is unspecified, it defaults to 1, which does not change the sampling rate.  If this value is 2</span>
0053 <span class="comment">%                  or larger, the returned voltage, current, and time data will be downsampled by keeping every N-th sample</span>
0054 <span class="comment">%                  in the original data, starting with the first.</span>
0055 <span class="comment">%                  Caution:  No lowpass filtering is applied prior to downsampling, so aliasing may occur.  Also,</span>
0056 <span class="comment">%                  in many cases LTspice saves data with a non-constant sampling rate, in which case downsampling can</span>
0057 <span class="comment">%                  result in substantial waveform distortion.  This option should only be used if the waveform of</span>
0058 <span class="comment">%                  interest is initially oversampled.</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%    Outputs:  RAW_DATA is a Matlab structure containing the following fields ...</span>
0061 <span class="comment">%                  title:                String containing the title appearing in the .RAW file header.</span>
0062 <span class="comment">%                  date:                 String containing the date appearing in the .RAW file header.</span>
0063 <span class="comment">%                  plotname:             String indicating simulation type ('Transient Analysis', 'AC Analysis')</span>
0064 <span class="comment">%                  conversion_notes:     Description of modifications (if any) done to the data during conversion.</span>
0065 <span class="comment">%                  num_variables:        Number of variables (does not include the &quot;time&quot; or &quot;frequency&quot; variable)</span>
0066 <span class="comment">%                  variable_type_list:   A cell of strings indicating the variable type (i.e. voltage, current etc.)</span>
0067 <span class="comment">%                  variable_name_list:   A cell of strings indicating the name of each variable.</span>
0068 <span class="comment">%                  selected_vars:        A vector of indicies referencing VARIABLE_TYPE_LIST cells, corresponding</span>
0069 <span class="comment">%                                        to each row in VARIABLE_MAT.</span>
0070 <span class="comment">%                  num_data_pnts:        Number of data points for each variable.</span>
0071 <span class="comment">%                  variable_mat:         Double precision matrix with NUM_VARIABLES rows and NUM_DATA_PNTS columns.</span>
0072 <span class="comment">%                                        This matrix contains node voltages (in Volts) and device currents (in Amps)</span>
0073 <span class="comment">%                                        for each variable and each time point listed in TIME_VECT (or FREQ_VECT).</span>
0074 <span class="comment">%                                        For AC Analysis simulations, VARIABLE_MAT will have complex values showing</span>
0075 <span class="comment">%                                        the real and imaginary components of the voltage or current at the</span>
0076 <span class="comment">%                                        corresponding frequency.  To convert this to log magnitude and normalized</span>
0077 <span class="comment">%                                        phase representation used in LTspice plots, use the following formulas:</span>
0078 <span class="comment">%                                            Log_Magnitude_dB    =  20*log10(abs(variable_mat))</span>
0079 <span class="comment">%                                            Norm_Phase_degrees  =  angle(variable_mat)*180/pi</span>
0080 <span class="comment">%                  time_vect:            [Field returned for Transient Analysis only] Double precision row vector of</span>
0081 <span class="comment">%                                        time values (in seconds) at each simulation point</span>
0082 <span class="comment">%                    (or)</span>
0083 <span class="comment">%                  freq_vect:            [Field returned for AC Analysis only] Double precision row vector of</span>
0084 <span class="comment">%                                        frequency values (in Hz) at each simulation point</span>
0085 <span class="comment">%</span>
0086 <span class="comment">%    ** Currently this function is able to import results from Transient Analysis (.tran) and AC Analysis (.ac)</span>
0087 <span class="comment">%       simulations only.</span>
0088 <span class="comment">%</span>
0089 <span class="comment">%</span>
0090 <span class="comment">%    Examples</span>
0091 <span class="comment">%    --------</span>
0092 <span class="comment">%    These examples assume you've run a .TRAN simulation in LTspice for a hypothetical file called</span>
0093 <span class="comment">%    BASIC_CIRCUIT.ASC, and that an output file called BASIC_CIRCUIT.RAW has been created.  It also assumes your</span>
0094 <span class="comment">%    current Matlab directory is pointing to the directory where the .RAW file is located (or that you prepended</span>
0095 <span class="comment">%    the full path to the input parameter FILENAME).</span>
0096 <span class="comment">%</span>
0097 <span class="comment">%    To import BASIC_CIRCUIT.RAW into Matlab and create a labeled plot of a single variable vs. time:</span>
0098 <span class="comment">%</span>
0099 <span class="comment">%       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW');</span>
0100 <span class="comment">%       variable_to_plot = 1;   %This example plots the first variable in the data structure.</span>
0101 <span class="comment">%       plot(raw_data.time_vect, raw_data.variable_mat(variable_to_plot,:), 'k');</span>
0102 <span class="comment">%       title(sprintf('Waveform %s', raw_data.variable_name_list{variable_to_plot}));</span>
0103 <span class="comment">%       ylabel(raw_data.variable_type_list{variable_to_plot} );</span>
0104 <span class="comment">%       xlabel('Time (sec)' );</span>
0105 <span class="comment">%</span>
0106 <span class="comment">%   To superimpose all variables in BASIC_CIRCUIT.RAW on a single graph with a legend:</span>
0107 <span class="comment">%</span>
0108 <span class="comment">%       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW');</span>
0109 <span class="comment">%       plot(raw_data.time_vect, raw_data.variable_mat);</span>
0110 <span class="comment">%       title(sprintf( 'File:  %s', raw_data.title));</span>
0111 <span class="comment">%       legend(raw_data.variable_name_list);</span>
0112 <span class="comment">%       ylabel('Voltage (V) or Current (A)');</span>
0113 <span class="comment">%       xlabel('Time (sec)');</span>
0114 <span class="comment">%</span>
0115 <span class="comment">%   To quickly determine the number and names of variables in BASIC_CIRCUIT.RAW without loading the entire file:</span>
0116 <span class="comment">%</span>
0117 <span class="comment">%       raw_data = LTspice2Matlab('BASIC_CIRCUIT.RAW', []);</span>
0118 <span class="comment">%       disp(sprintf( '\n\nThis file contains %.0f variables:\n', raw_data.num_variables));</span>
0119 <span class="comment">%       disp(sprintf('NAME         TYPE\n-------------------------'));</span>
0120 <span class="comment">%       disp([char(raw_data.variable_name_list), char(zeros(raw_data.num_variables,5)), char(raw_data.variable_type_list)]);</span>
0121 <span class="comment">%</span>
0122 <span class="comment">%</span>
0123 <span class="comment">%</span>
0124       
0125         
0126 
0127     raw_data = [];  <span class="comment">%Initialize the output structure.</span>
0128 
0129     <span class="keyword">if</span> nargin==0,
0130         error( <span class="string">'LTspice2Matlab takes 1, 2, or 3 input parameters.  Type &quot;help LTspice2Matlab&quot; for details'</span> );
0131     <span class="keyword">elseif</span> nargin==1,
0132         selected_vars = <span class="string">'all'</span>;
0133         downsamp_N = 1;
0134     <span class="keyword">elseif</span> nargin==2,
0135         selected_vars = varargin{1};
0136         <span class="keyword">if</span> ischar(selected_vars),  selected_vars = lower(selected_vars);  <span class="keyword">end</span>
0137         downsamp_N = 1;
0138     <span class="keyword">elseif</span> nargin==3,
0139         selected_vars = varargin{1};
0140         <span class="keyword">if</span> ischar(selected_vars),  selected_vars = lower(selected_vars);  <span class="keyword">end</span>
0141         downsamp_N = varargin{2};
0142     <span class="keyword">else</span>
0143         error( <span class="string">'LTspice2Matlab takes only 1, 2, or 3 input parameters.  Type &quot;help LTspice2Matlab&quot; for details'</span> );
0144     <span class="keyword">end</span>
0145     
0146     
0147     <span class="keyword">if</span> length(downsamp_N)~=1 | ~isnumeric(downsamp_N) | isnan(downsamp_N) | mod(downsamp_N,1)~=0.0 | downsamp_N&lt;=0,
0148         error( <span class="string">'Optional parameter DOWNSAMP_N must be a positive integer &gt;= 1'</span> );
0149     <span class="keyword">end</span>
0150     
0151     
0152     filename = fliplr(deblank(fliplr(deblank(filename))));   <span class="comment">%Remove leading and trailing spaces from filename.</span>
0153     fid = fopen(filename, <span class="string">'rb'</span>);
0154     <span class="keyword">if</span> length(fid)==1 &amp; isnumeric(fid) &amp; fid==-1,
0155         <span class="comment">%try to append &quot;.raw&quot; to the file name ...</span>
0156         fid = fopen(sprintf( <span class="string">'%s.raw'</span>, filename ), <span class="string">'rb'</span>);
0157         <span class="keyword">if</span> length(fid)==1 &amp; isnumeric(fid) &amp; fid==-1,
0158             error( sprintf( <span class="string">'Could not open file &quot;%s&quot;'</span>, filename ) );
0159         <span class="keyword">end</span>
0160     <span class="keyword">end</span>
0161        
0162     
0163     [filename, the_permision, machineformat] = fopen(fid);
0164 
0165     <span class="comment">%Load header tags &amp; information</span>
0166     variable_name_list = {};  variable_type_list = {};   <span class="comment">%These include voltages and currents only.  Does not include the time vector.</span>
0167     variable_flag = 0;
0168     file_format = <span class="string">''</span>;
0169     <span class="keyword">while</span> 1,   
0170         the_line = fgetl(fid);
0171         <span class="keyword">if</span> length(the_line)==1 &amp; isnumeric(the_line) &amp; double(the_line)==-1,  
0172             <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span>  <span class="keyword">end</span>
0173             error( sprintf( <span class="string">'Format error in LTspice file &quot;%s&quot; ... End of file unexpectedly encountered'</span>, filename ));
0174         <span class="keyword">end</span>
0175         
0176         the_line = <a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(the_line);
0177         
0178         <span class="keyword">if</span> length(strfind( the_line, <span class="string">'Binary:'</span> ))~=0,  file_format = <span class="string">'binary'</span>;  <span class="keyword">break</span>;  <span class="keyword">end</span>
0179         <span class="keyword">if</span> length(strfind( the_line, <span class="string">'Values:'</span> ))~=0,  file_format = <span class="string">'ascii'</span>;   <span class="keyword">break</span>;  <span class="keyword">end</span>
0180         
0181         <span class="keyword">if</span> variable_flag==0,  <span class="comment">%Non-variable header section</span>
0182             <span class="keyword">if</span> length(the_line)==0,  colon_index = [];
0183             <span class="keyword">else</span>,  colon_index = find( the_line == <span class="string">':'</span> );  <span class="keyword">end</span>
0184             <span class="keyword">if</span> length(colon_index)==0,  
0185                 <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0186                 error( sprintf( <span class="string">'Format error in LTspice file &quot;%s&quot;'</span>, filename ));  
0187             <span class="keyword">end</span>
0188             var_name = the_line(1:(colon_index(1)-1));
0189             var_value = fliplr(deblank(fliplr(deblank(the_line((colon_index(1)+1):end)))));
0190 
0191             vn_keep_index = find( var_name~=<span class="string">' '</span> &amp; var_name~=<span class="string">'.'</span> &amp; var_name~=<a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(9) &amp; var_name~=<a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(10) &amp; var_name~=<a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(13) );
0192             var_name = lower(var_name(vn_keep_index));
0193             <span class="keyword">if</span> length(var_name)==0 | (var_name(1)&gt;=<span class="string">'0'</span> &amp; var_name(1)&lt;=<span class="string">'9'</span>),  
0194                 <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0195                 error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... Bad tag name found'</span>, filename ));  
0196             <span class="keyword">end</span>
0197 
0198             <span class="keyword">if</span> strcmpi( var_name, <span class="string">'variables'</span> ) | strcmpi( var_name, <span class="string">'variable'</span> ),  variable_flag = 1;  <span class="keyword">continue</span>;  <span class="keyword">end</span>
0199             value_try = str2num(var_value);
0200             <span class="keyword">try</span>
0201                 <span class="keyword">if</span> length(value_try)==0,  raw_data = setfield( raw_data, var_name, var_value );
0202                 <span class="keyword">else</span> raw_data = setfield( raw_data, var_name, value_try );  <span class="keyword">end</span>
0203             <span class="keyword">catch</span>
0204                 <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0205                 error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... Bad tag name found'</span>, filename ));  
0206             <span class="keyword">end</span>
0207             
0208         <span class="keyword">else</span>  <span class="comment">%Variable header section</span>
0209             leading_ch_index = find( (the_line(1:end-1)==<span class="string">' '</span> | the_line(1:end-1)==<a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(9)) &amp; (the_line(2:end)~=<span class="string">' '</span> &amp; the_line(2:end)~=<a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(9)) );
0210             <span class="keyword">if</span> length(leading_ch_index)~=3,  
0211                 <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0212                 error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... Wrong number of columns in the variable define section'</span>, filename ));  
0213             <span class="keyword">end</span>
0214             
0215             part1 = fliplr(deblank(fliplr(deblank(the_line( (leading_ch_index(1)+1) : leading_ch_index(2) )))));
0216             part2 = fliplr(deblank(fliplr(deblank(the_line( (leading_ch_index(2)+1) : leading_ch_index(3) )))));
0217             part3 = fliplr(deblank(fliplr(deblank(the_line( (leading_ch_index(3)+1) : end )))));
0218             
0219             <span class="keyword">if</span> str2num(part1)~=length(variable_name_list),  
0220                 <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0221                 error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... Inconsistency found in the variable define section'</span>, filename ));  
0222             <span class="keyword">end</span>
0223             variable_name_list{end+1} = part2;
0224             variable_type_list{end+1} = part3;
0225         <span class="keyword">end</span>
0226     <span class="keyword">end</span>
0227     
0228     <span class="comment">%Check raw_data structure for required fields</span>
0229     expected_tags      = {<span class="string">'title'</span>, <span class="string">'date'</span>, <span class="string">'plotname'</span>, <span class="string">'flags'</span>, <span class="string">'novariables'</span>,   <span class="string">'nopoints'</span>    };
0230     expected_tags_full = {<span class="string">'Title'</span>, <span class="string">'Date'</span>, <span class="string">'Plotname'</span>, <span class="string">'Flags'</span>, <span class="string">'No. Variables'</span>, <span class="string">'No. Points'</span>  };
0231     <span class="keyword">for</span> q=1:length(expected_tags),
0232         <span class="keyword">if</span> ~isfield( raw_data, lower(expected_tags{q}) ),  
0233             <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0234             error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... tag &quot;%s&quot; not found'</span>, filename, expected_tags_full{q} ));  
0235         <span class="keyword">end</span>
0236     <span class="keyword">end</span>
0237     
0238     raw_data.conversion_notes = <span class="string">''</span>;
0239     raw_data.num_data_pnts = raw_data.nopoints;  raw_data = rmfield( raw_data, <span class="string">'nopoints'</span> );
0240     raw_data.num_variables = raw_data.novariables-1;  raw_data = rmfield( raw_data, <span class="string">'novariables'</span> );
0241     <span class="comment">%&quot;raw_data.num_variables&quot; does not include the time vector (index 0 in the .raw file)</span>
0242 
0243     <span class="keyword">if</span> isfield( raw_data, <span class="string">'command'</span> ),  raw_data = rmfield( raw_data, <span class="string">'command'</span> );  <span class="keyword">end</span>
0244     <span class="keyword">if</span> isfield( raw_data, <span class="string">'backannotation'</span> ),  raw_data = rmfield( raw_data, <span class="string">'backannotation'</span> );  <span class="keyword">end</span>
0245     <span class="keyword">if</span> isfield( raw_data, <span class="string">'offset'</span> ),  
0246         general_offset = raw_data.offset;  <span class="comment">%(sec)</span>
0247         raw_data = rmfield( raw_data, <span class="string">'offset'</span> );  
0248     <span class="keyword">else</span>
0249         general_offset = 0.0;
0250     <span class="keyword">end</span>
0251     
0252     
0253     raw_data.variable_name_list = {variable_name_list{2:end}};        <span class="comment">%cut off the time variable.</span>
0254     raw_data.variable_type_list = {variable_type_list{2:end}};
0255     
0256     simulation_type = <span class="string">''</span>;
0257     <span class="keyword">if</span>     length(strfind( lower(raw_data.plotname), <span class="string">'transient analysis'</span> ))~=0,           simulation_type = <span class="string">'.tran'</span>;   <span class="comment">%SUPPORTED</span>
0258     <span class="keyword">elseif</span> length(strfind( lower(raw_data.plotname), <span class="string">'ac analysis'</span> ))~=0,                  simulation_type = <span class="string">'.ac'</span>;     <span class="comment">%SUPPORTED</span>
0259     <span class="keyword">elseif</span> length(strfind( lower(raw_data.plotname), <span class="string">'dc transfer characteristic'</span> ))~=0,   simulation_type = <span class="string">'.dc'</span>;     <span class="comment">%This is a DC sweep (Not supported)</span>
0260     <span class="keyword">elseif</span> length(strfind( lower(raw_data.plotname), <span class="string">'operating point'</span> ))~=0,              simulation_type = <span class="string">'.op'</span>;     <span class="comment">%This is a DC operating point (Not supported)</span>
0261     <span class="keyword">end</span>
0262     
0263     <span class="keyword">if</span> length(simulation_type)==0 | ~(strcmpi(simulation_type, <span class="string">'.tran'</span>) | strcmpi(simulation_type, <span class="string">'.ac'</span>)),
0264         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0265         error( <span class="string">'Currently LTspice2Matlab is only able to import results from Transient Analysis (.tran) and AC Analysis (.ac) simulations.'</span> );
0266     <span class="keyword">end</span>
0267 
0268     <span class="keyword">if</span> length(strfind( lower(raw_data.flags), <span class="string">'fastaccess'</span> ))~=0,
0269         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0270         error( <span class="string">'LTspice2Matlab cannot convert files saved in the &quot;Fast Access&quot; format.'</span> );
0271     <span class="keyword">end</span>
0272     <span class="keyword">if</span> strcmpi(simulation_type, <span class="string">'.tran'</span>) &amp; length(strfind( lower(raw_data.flags), <span class="string">'real'</span> ))==0,
0273         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0274         error( <span class="string">'Expected to find &quot;real&quot; flag for a Transient Analysis (.tran) simulation.  Unsure how to convert the data'</span> );
0275     <span class="keyword">end</span>
0276     <span class="keyword">if</span> strcmpi(simulation_type, <span class="string">'.tran'</span>) &amp; length(strfind( lower(raw_data.flags), <span class="string">'forward'</span> ))==0,
0277         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0278         error( <span class="string">'Expected to find &quot;forward&quot; flag for a Transient Analysis (.tran) simulation.  Unsure how to convert the data'</span> );
0279     <span class="keyword">end</span>
0280     
0281     <span class="keyword">if</span> strcmpi(simulation_type, <span class="string">'.ac'</span>) &amp; length(strfind( lower(raw_data.flags), <span class="string">'complex'</span> ))==0,
0282         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0283         error( <span class="string">'Expected to find &quot;complex&quot; flag for an AC Analysis (.ac) simulation.  Unsure how to convert the data'</span> );
0284     <span class="keyword">end</span>
0285     <span class="keyword">if</span> strcmpi(simulation_type, <span class="string">'.ac'</span>) &amp; length(strfind( lower(raw_data.flags), <span class="string">'forward'</span> ))==0,
0286         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0287         error( <span class="string">'Expected to find &quot;forward&quot; flag for an AC Analysis (.ac) simulation.  Unsure how to convert the data'</span> );
0288     <span class="keyword">end</span>
0289     <span class="keyword">if</span> isfield( raw_data, <span class="string">'flags'</span> ),  raw_data = rmfield( raw_data, <span class="string">'flags'</span> );  <span class="keyword">end</span>
0290 
0291     
0292     <span class="keyword">if</span> ischar(selected_vars),
0293         <span class="keyword">if</span> strcmpi(selected_vars, <span class="string">'all'</span>) | strcmpi(selected_vars, <span class="string">'everything'</span>) | strcmpi(selected_vars, <span class="string">'complete'</span>) | strcmpi(selected_vars, <span class="string">'all variables'</span>) | <span class="keyword">...</span>
0294                 strcmpi(selected_vars, <span class="string">'all vars'</span>) | strcmpi(selected_vars, <span class="string">'every thing'</span>) | strcmpi(selected_vars, <span class="string">'every'</span>),  
0295             selected_vars = 1:raw_data.num_variables;     <span class="comment">%Return all variables</span>
0296         <span class="keyword">else</span>
0297             <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0298             error( <span class="string">'Bad value for optional input parameter SELECTED_VARS'</span> );
0299         <span class="keyword">end</span>
0300     <span class="keyword">end</span>
0301     
0302     
0303     <span class="keyword">if</span> size(selected_vars,1)==0 | size(selected_vars,2)==0,  
0304         raw_data.selected_vars = [];
0305         raw_data.variable_mat = [];
0306         raw_data.time_vect = [];
0307         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0308         <span class="keyword">return</span>;
0309     <span class="keyword">end</span>
0310     <span class="keyword">if</span> size(selected_vars,1)&gt;1 &amp; size(selected_vars,2)&gt;1,  
0311         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0312         error( <span class="string">'SELECTED_VARS must be a row or column vector, not a matrix'</span> );  
0313     <span class="keyword">end</span>
0314     <span class="keyword">if</span> length(find(selected_vars==0))~=0,  
0315         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0316         error( <span class="string">'The time vector (index 0) is returned separately.  \n   Values in input parameter SELECTED_VARS must be positive integers &gt;= 1 and &lt;= NUM_VARIABLES'</span> );  
0317     <span class="keyword">end</span>
0318     non_integer_index = find(isnan(selected_vars) | ~isnumeric(selected_vars) | mod( selected_vars, 1 )~=0.0);
0319     <span class="keyword">if</span> length(non_integer_index)~=0,  
0320         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0321         error( <span class="string">'Values in input parameter SELECTED_VARS must be positive integers &gt;= 1 and &lt;= NUM_VARIABLES'</span> );  
0322     <span class="keyword">end</span>
0323     missing_index = find( ~ismember( selected_vars, 1:raw_data.num_variables ) );
0324     <span class="keyword">if</span> length(missing_index)~=0,  
0325         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0326         error( <span class="string">'Error in input parameter SELECTED_VARS ... Out of range value(s) found'</span> );  
0327     <span class="keyword">end</span>
0328     
0329     selected_vars = unique(selected_vars);   <span class="comment">%remove duplicates and sort in ascending order.</span>
0330     raw_data.selected_vars = selected_vars;
0331 
0332     
0333     NumPnts = raw_data.num_data_pnts;
0334     NumPnts_DS = floor(NumPnts/downsamp_N);
0335     raw_data.num_data_pnts = NumPnts_DS;   <span class="comment">%Updated # of points</span>
0336     NumVars = raw_data.num_variables+1;
0337     
0338     
0339     <span class="comment">%READ IN THE ACTUAL WAVEFORM DATA</span>
0340     <span class="keyword">if</span> strcmpi(file_format, <span class="string">'binary'</span>),
0341         binary_start = ftell(fid);   <span class="comment">%start of binary data section.</span>
0342         
0343         <span class="keyword">if</span> strcmpi( simulation_type, <span class="string">'.tran'</span> ),
0344             <span class="comment">% For Transient Analysis simulations, the time data is stored in double precision floating point binary format,</span>
0345             <span class="comment">% and everything else is stored in single precision format.</span>
0346 
0347             <span class="comment">%Extract the binary data in the fewest possible number of contiguous blocks</span>
0348             <span class="keyword">if</span> length(selected_vars)&gt;1,
0349                 g_border = find( [2, diff(selected_vars), 2]~=1 );
0350                 block_list = {};
0351                 <span class="keyword">for</span> k=1:length(g_border)-1,  block_list{k} = g_border(k):(g_border(k+1)-1);  <span class="keyword">end</span>
0352             <span class="keyword">else</span>
0353                 block_list = {1:length(selected_vars)};
0354             <span class="keyword">end</span>
0355 
0356             raw_data.variable_mat = zeros(length(selected_vars), NumPnts_DS);  <span class="comment">%Initialize.</span>
0357             <span class="keyword">for</span> k=1:length(block_list),
0358                 target_var_index = selected_vars(block_list{k});
0359                 fseek(fid, binary_start + (target_var_index(1)+1)*4, <span class="string">'bof'</span>); 
0360                 TVIL = length(target_var_index);
0361                 bytes_skip = (NumVars+1-TVIL)*4  +  (downsamp_N-1)*(NumVars+1)*4;
0362                 precision_str = sprintf(<span class="string">'%.0f*float'</span>,TVIL);
0363                 raw_data.variable_mat(block_list{k},:) = reshape( fread(fid, NumPnts_DS*TVIL, precision_str, bytes_skip, machineformat), TVIL, NumPnts_DS );
0364             <span class="keyword">end</span>    
0365 
0366             fseek(fid, binary_start, <span class="string">'bof'</span>);    <span class="comment">%rewind to start, then extract the time vector.</span>
0367             raw_data.time_vect = fread( fid, NumPnts_DS, <span class="string">'double'</span>, (NumVars-1)*4 + (downsamp_N-1)*(NumVars+1)*4, machineformat ).';
0368             <span class="keyword">if</span> downsamp_N==1,  raw_data.conversion_notes = <span class="string">'Converted from Binary format'</span>;
0369             <span class="keyword">else</span> raw_data.conversion_notes = sprintf( <span class="string">'Converted from Binary format.  Downsampled from %.0f to %.0f points'</span>, NumPnts, NumPnts_DS );  <span class="keyword">end</span>
0370             
0371         <span class="keyword">elseif</span> strcmpi( simulation_type, <span class="string">'.ac'</span> ),
0372             <span class="comment">% For AC Analysis simulations, the frequency data is stored in double precision floating point binary format (8 bytes),</span>
0373             <span class="comment">% and the variables are stored as complex double precision arrays (8 bytes real followed by 8 bytes imag)</span>
0374             
0375             <span class="comment">%Extract the binary data in the fewest possible number of contiguous blocks</span>
0376             <span class="keyword">if</span> length(selected_vars)&gt;1,
0377                 g_border = find( [2, diff(selected_vars), 2]~=1 );
0378                 block_list = {};
0379                 <span class="keyword">for</span> k=1:length(g_border)-1,  block_list{k} = g_border(k):(g_border(k+1)-1);  <span class="keyword">end</span>
0380             <span class="keyword">else</span>
0381                 block_list = {1:length(selected_vars)};
0382             <span class="keyword">end</span>
0383 
0384             raw_data.variable_mat = zeros(length(selected_vars), NumPnts_DS);  <span class="comment">%Initialize.</span>
0385             <span class="keyword">if</span> prod(size(raw_data.variable_mat))~=0,  raw_data.variable_mat(1,1) = 0.0 + j*0.0;  <span class="keyword">end</span>  <span class="comment">%Allocate memory for complex double.</span>
0386             <span class="keyword">for</span> k=1:length(block_list),
0387                 target_var_index = selected_vars(block_list{k});
0388                 fseek(fid, binary_start + target_var_index(1)*16, <span class="string">'bof'</span>); 
0389                 TVIL = length(target_var_index);
0390                 bytes_skip = (NumVars-TVIL)*16  +  (downsamp_N-1)*NumVars*16;
0391                 precision_str = sprintf(<span class="string">'%.0f*double'</span>,TVIL*2);
0392                 temp_buff = reshape(fread(fid, NumPnts_DS*TVIL*2, precision_str, bytes_skip, machineformat), TVIL*2, NumPnts_DS );
0393                 raw_data.variable_mat(block_list{k},:) = temp_buff(1:2:end-1,:) + j*temp_buff(2:2:<span class="keyword">end</span>,:);
0394                 clear temp_buff;
0395             <span class="keyword">end</span>    
0396 
0397             fseek(fid, binary_start, <span class="string">'bof'</span>);    <span class="comment">%rewind to start, then extract the time vector.</span>
0398             raw_data.freq_vect = fread( fid, NumPnts_DS, <span class="string">'double'</span>, (NumVars-1)*16 + 8 + (downsamp_N-1)*NumVars*16, machineformat ).';
0399             
0400         <span class="keyword">else</span>
0401             <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0402             error( sprintf(<span class="string">'Simulation type (%s) not currently supported'</span>, simulation_type ));
0403         <span class="keyword">end</span>
0404         
0405         
0406     <span class="keyword">elseif</span> strcmpi(file_format, <span class="string">'ascii'</span> ),
0407         
0408         <span class="keyword">if</span> strcmpi( simulation_type, <span class="string">'.tran'</span> ),
0409             <span class="comment">%Format:  point number, time value, var1, var2, var3 ... varN</span>
0410             raw_data.variable_mat = fscanf( fid, <span class="string">'%g'</span>, [raw_data.num_variables+2, raw_data.num_data_pnts] );   <span class="comment">%matrix is filled in column order.</span>
0411             <span class="keyword">if</span> (size(raw_data.variable_mat,1)~=raw_data.num_variables+2) | (size(raw_data.variable_mat,2)~=raw_data.num_data_pnts),
0412                 error( sprintf(<span class="string">'Format error in ASCII Transient Analysis LTspice file &quot;%s&quot; ... Incorrect number of data values read'</span>, filename ));
0413             <span class="keyword">end</span>
0414             raw_data.time_vect = raw_data.variable_mat(2,1:downsamp_N:end);
0415             raw_data.variable_mat = raw_data.variable_mat(2+selected_vars,1:downsamp_N:end);
0416             
0417         <span class="keyword">elseif</span> strcmpi( simulation_type, <span class="string">'.ac'</span> ),
0418             <span class="comment">%Format:  point number, freq value, 0, var1 real, var1 imag, var2 real, var2 imag, var3 real, var3 imag ... varN real, varN imag</span>
0419             all_data = fread( fid, inf, <span class="string">'uchar'</span> );
0420             all_data( find( all_data == <span class="string">','</span> ) ) = sprintf( <span class="string">'\t'</span> );  <span class="comment">%Replace commas with tab characters</span>
0421             raw_data.variable_mat = sscanf( <a href="../../v08/m2html/@template/char.html" class="code" title="function s = char(tpl)">char</a>(all_data), <span class="string">'%g'</span>, [3+2*raw_data.num_variables, raw_data.num_data_pnts] );
0422             clear all_data;
0423             <span class="comment">%raw_data.variable_mat = fscanf( fid, '%g', [3+2*raw_data.num_variables, raw_data.num_data_pnts] );   %matrix is filled in column order.</span>
0424             
0425             <span class="keyword">if</span> (size(raw_data.variable_mat,1)~=(3+2*raw_data.num_variables)) | (size(raw_data.variable_mat,2)~=raw_data.num_data_pnts),
0426                 error( sprintf(<span class="string">'Format error in ASCII AC Analysis LTspice file &quot;%s&quot; ... Incorrect number of data values read'</span>, filename ));
0427             <span class="keyword">end</span>
0428             raw_data.freq_vect = raw_data.variable_mat(2,1:downsamp_N:end);
0429             raw_data.variable_mat = raw_data.variable_mat(3+selected_vars*2-1,1:downsamp_N:end) + j*raw_data.variable_mat(3+selected_vars*2,1:downsamp_N:end);
0430             
0431         <span class="keyword">else</span>
0432             <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0433             error( sprintf(<span class="string">'Simulation type (%s) not currently supported'</span>, simulation_type ));
0434         <span class="keyword">end</span>
0435         
0436         <span class="keyword">if</span> downsamp_N==1,  raw_data.conversion_notes = <span class="string">'Converted from ASCII format'</span>;
0437         <span class="keyword">else</span> raw_data.conversion_notes = sprintf( <span class="string">'Converted from ASCII format.  Downsampled from %.0f to %.0f points'</span>, NumPnts, NumPnts_DS );  <span class="keyword">end</span>
0438         
0439     <span class="keyword">else</span>
0440         <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0441         error( sprintf(<span class="string">'Format error in LTspice file &quot;%s&quot; ... Data type ID tag not found'</span>, filename ));
0442     <span class="keyword">end</span>
0443 
0444     <span class="keyword">try</span> fclose( fid );  <span class="keyword">catch</span> <span class="keyword">end</span>
0445     
0446     
0447     
0448     <span class="comment">%Deal with potential compression in Transient Analysis simulations</span>
0449     <span class="keyword">if</span> strcmpi( simulation_type, <span class="string">'.tran'</span> ) &amp; (min(diff(raw_data.time_vect)) &lt; 0.0),   <span class="comment">%Check to see if the time vector is monotonically increasing.</span>
0450         
0451         <span class="keyword">if</span> downsamp_N~=1,  <span class="comment">%If we have already downsampled then we can't uncompress.</span>
0452             raw_data.time_vect = abs(raw_data.time_vect);            
0453             
0454         <span class="keyword">else</span>
0455             <span class="comment">%The binary file contains 2nd order compression ... use 2nd-order interpolation to add data points in the vicinity of negative time points</span>
0456 
0457             t_vect = raw_data.time_vect;   <span class="comment">%We will add in the offset later.</span>
0458             neg_pnt_index = find( t_vect &lt; 0.0 &amp; [0,ones(1,length(t_vect)-1)] );
0459             t_vect = abs(t_vect);
0460 
0461             x1 = t_vect(neg_pnt_index-1);  x2 = t_vect(neg_pnt_index);  x3 = t_vect(neg_pnt_index+1);
0462             x_new = [(2*x1 + x2)/3;  (x1 + 2*x2)/3;  (2*x2 + x3)/3;  (x2 + 2*x3)/3];   <span class="comment">%New sample points</span>
0463 
0464             t_vect_big = NaN*zeros(6,length(t_vect));
0465             t_vect_big(1,:) = t_vect;
0466             t_vect_big(4,neg_pnt_index) = t_vect(neg_pnt_index);
0467             t_vect_big(1,neg_pnt_index) = NaN;
0468             t_vect_big([2 3 5 6],neg_pnt_index) = x_new;
0469 
0470             full_index = find(~isnan(t_vect_big));
0471             time_vect_new = t_vect_big(full_index).';   <span class="comment">%This is the new time vector with the inserted points.</span>
0472             t_vect_big([1,4],:) = NaN;
0473             nan_vect = isnan(t_vect_big(full_index));
0474             new_index = find( ~nan_vect );  <span class="comment">%Index into time_vect_new indicating the new points only.</span>
0475             old_index = find( nan_vect );
0476             clear t_vect t_vect_big full_index nan_vect;
0477 
0478             x1sqr = repmat( x1.^2, [4,1] );  x2sqr = repmat( x2.^2, [4,1] );  x3sqr = repmat( x3.^2, [4,1] );
0479             x1 = repmat( x1, [4,1] );  x2 = repmat( x2, [4,1] );  x3 = repmat( x3, [4,1] );
0480             denom = (x1sqr-x2sqr).*(x2-x3) - (x2sqr-x3sqr).*(x1-x2);
0481             r1 = (x_new.^2 - x1sqr)./denom;
0482             r2 = (x_new - x1)./denom;
0483             p1 = (x2-x3).*r1 - (x2sqr-x3sqr).*r2;
0484             p3 = (x1-x2).*r1 - (x1sqr-x2sqr).*r2;
0485             p2 = -p1 - p3;
0486             p1 = p1 + 1;
0487             clear x_new x1sqr x2sqr x3sqr x1 x2 x3 denom r1 r2;
0488 
0489             raw_data.variable_mat(:,end+1:length(time_vect_new)) = 0.0;   <span class="comment">%Init the memory</span>
0490             <span class="keyword">for</span> k=1:size(raw_data.variable_mat,1),
0491                 y_vect = raw_data.variable_mat(k,1:length(raw_data.time_vect));
0492                 raw_data.variable_mat(k,old_index) = y_vect;
0493                 y_new = repmat(y_vect(neg_pnt_index-1),[4,1]).*p1  +  repmat(y_vect(neg_pnt_index),[4,1]).*p2  +  repmat(y_vect(neg_pnt_index+1),[4,1]).*p3;
0494                 raw_data.variable_mat(k,new_index) = y_new(:).';
0495             <span class="keyword">end</span>
0496             raw_data.time_vect = time_vect_new;
0497             clear time_vect_new y_vect y_new new_index old_index neg_pnt_index p1 p2 p3;
0498 
0499             raw_data.conversion_notes = sprintf( <span class="string">'Converted from Binary format with 2nd Order compression.  Upsampled waveforms from %.0f to %.0f points'</span>, <span class="keyword">...</span>
0500                 raw_data.num_data_pnts, length(raw_data.time_vect) );
0501             raw_data.num_data_pnts = length(raw_data.time_vect);
0502         <span class="keyword">end</span>
0503         
0504     <span class="keyword">end</span>
0505     
0506     <span class="keyword">if</span> isfield( raw_data, <span class="string">'time_vect'</span> ),      raw_data.time_vect = raw_data.time_vect + general_offset;
0507     <span class="keyword">elseif</span> isfield( raw_data, <span class="string">'freq_vect'</span> ),  raw_data.freq_vect = raw_data.freq_vect + general_offset;
0508     <span class="keyword">end</span>
0509</pre></div>
<hr><address>Generated on Thu 11-Feb-2016 12:45:32 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>